apiVersion: apps/v1
kind: Deployment
metadata:
  name: signingservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: signingservice
  template:
    metadata:
      labels:
        app: signingservice
    spec:
      initContainers:
        - name: generate-configs
          image: busybox
          command:
            - sh
            - -c
            - |
              mkdir -p /configs

              # Generate keys.yaml
              cat <<EOF > /configs/keys.yaml
              chain:
                bsc:
                  chain_type: evm
                  private_key: "$BSC_PRIVATE_KEY"
                  wallet_address: "$BSC_WALLET_ADDRESS"
                holesky:
                  chain_type: evm
                  private_key: "$BSC_PRIVATE_KEY"
                  wallet_address: "$BSC_WALLET_ADDRESS"
                aleo:
                  chain_type: aleo
                  private_key: "$ALEO_PRIVATE_KEY"
                  wallet_address: "$ALEO_WALLET_ADDRESS"
              EOF

              # Generate config.yaml
              cat <<EOF > /configs/config.yaml
              chains:
                - name: aleo
                  chain_type: aleo
                  chain_id: "$ALEO_CHAIN_ID"
                - name: bsc
                  chain_type: evm
                  chain_id: "$BSC_CHAIN_ID"
                - name: holesky
                  chain_type: evm
                  chain_id: "$BSC_CHAIN_ID"
              cred:
                username: "$SIGNING_SERVICE_USERNAME"
                password: "$SIGNING_SERVICE_PASSWORD"
              EOF
          env:
            # Private keys from Secret
            - name: ALEO_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: attestor-secret
                  key: ALEO_PRIVATE_KEY
            - name: BSC_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: attestor-secret
                  key: BSC_PRIVATE_KEY
            - name: HOLESKY_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: attestor-secret
                  key: HOLESKY_PRIVATE_KEY

            # Wallet addresses from ConfigMap
            - name: ALEO_WALLET_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: aleo_wallet_address
            - name: BSC_WALLET_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: bsc_wallet_address
            - name: HOLESKY_WALLET_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: holesky_wallet_address

            # Chain IDs from ConfigMap
            - name: ALEO_CHAIN_ID
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: aleo_chain_id
            - name: BSC_CHAIN_ID
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: bsc_chain_id
            - name: HOLESKY_CHAIN_ID
              valueFrom:
                configMapKeyRef:
                  name: attestor-config
                  key: holesky_chain_id

            # Username/password from Secret
            - name: SIGNING_SERVICE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: attestor-secret
                  key: SIGNING_SERVICE_USERNAME
            - name: SIGNING_SERVICE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: attestor-secret
                  key: SIGNING_SERVICE_PASSWORD

          volumeMounts:
            - name: signing-config-volume
              mountPath: /configs

      containers:
        - name: signingservice
          image: "venture23/verulink-attestor-sign:{{ .Values.docker_image_tag_sign }}"
          ports:
            - containerPort: {{ .Values.signing_service.port }}
          volumeMounts:
            - name: signing-config-volume
              mountPath: /configs/keys.yaml
              subPath: keys.yaml
              readOnly: true
            - name: signing-config-volume
              mountPath: /configs/config.yaml
              subPath: config.yaml
              readOnly: true
          envFrom:
            - secretRef:
                name: attestor-secret

      volumes:
        - name: signing-config-volume
          emptyDir: {}