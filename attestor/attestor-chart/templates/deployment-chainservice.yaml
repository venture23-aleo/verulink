apiVersion: apps/v1
kind: Deployment
metadata:
  name: chainservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: chainservice
  template:
    metadata:
      labels:
        app: chainservice
    spec:
      initContainers:
        - name: mtls-setup
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              cp /mtls-secret/ca.crt /mtls-output/ca.crt
              cp /mtls-secret/{{ .Values.chainService.name }}.crt /mtls-output/{{ .Values.chainService.name }}.crt
              cp /mtls-secret/{{ .Values.chainService.name }}.key /mtls-output/{{ .Values.chainService.name }}.key
              chmod 644 /mtls-output/ca.crt
              chmod 644 /mtls-output/{{ .Values.chainService.name }}.crt
              chmod 600 /mtls-output/{{ .Values.chainService.name }}.key
          volumeMounts:
            - name: mtls-secret
              mountPath: /mtls-secret
              readOnly: true
            - name: mtls
              mountPath: /mtls-output
      containers:
        - name: chainservice
          image: "{{ default "venture23/verulink-attestor-chain" .Values.image.chain.repository }}:{{ default "latest" .Values.image.chain.tag }}"
          # command:
          #   - sh
          #   - -c
          #   - |
          #     sleep infinity
          env:
            - name: DB_PATH
              value: {{ default "/var/lib/attestor" .Values.chainService.db_dir }}

            - name: LOG_PATH
              value: {{ default "/var/log/attestor" (index .Values.chainService.log.output_paths 0) }}

            - name: MODE
              value: {{ default "staging" .Values.chainService.mode }}

          volumeMounts:
            - name: storage
              mountPath: {{ default "/var/lib/attestor" .Values.chainService.db_dir }}
              subPath: db
    
            - name: storage
{{- $logPath := index .Values.chainService.log.output_paths 0 }}
{{- $logDir := "/var/log/attestor" }}
{{- if $logPath }}
{{- $logDir = $logPath | regexReplaceAll "/[^/]+$" "" }}
{{- if eq $logDir "" }}
{{- $logDir = "/var/log/attestor" }}
{{- end }}
{{- end }}
              mountPath: {{ $logDir }}
              subPath: log
    
            - name: chain-config
              mountPath: /configs/config.yaml
              subPath: config.yaml
    
            - name: mtls
              mountPath: /configs/.mtls
  
      volumes:
        - name: chain-config
          configMap:
            name: chain-config

        - name: mtls-secret
          secret:
            secretName: {{ .Values.secrets.existingSecretName }}
            items:
              - key: CA_MTLS_CERT
                path: ca.crt
              - key: ATTESTOR_MTLS_CERT
                path: {{ .Values.chainService.name }}.crt
              - key: ATTESTOR_MTLS_KEY
                path: {{ .Values.chainService.name }}.key

        - name: mtls
          emptyDir: {}

        - name: storage
{{- if eq (default "emptyDir" .Values.storage.type) "pvc" }}
          persistentVolumeClaim:
            claimName: attestor-storage
{{- else if eq (default "emptyDir" .Values.storage.type) "hostPath" }}
          hostPath:
            path: {{ .Values.storage.hostPathBase }}
{{- else }}
          emptyDir: {}
{{- end }}
