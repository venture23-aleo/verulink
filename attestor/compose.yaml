x-dbpath: &p # server as value holder for compose file
  /db

x-logpath: &l
  /log

services:
  chainservice:
    depends_on:
      signingservice:
        condition: service_healthy # Wait for the signingservice to be healthy
    build: ./chainService
    image : verulink/chainservice:8a428f7
    pull_policy: build # build or always
    volumes:
      - type: volume
        source: db-path
        target: *p
      - type: volume
        source: log-path
        target: *l      
      - type: bind
        source: ./chainService/config.yaml
        target: /configs/config.yaml
      - ./chainService/.mtls:/configs/.mtls
      - ./chainService/auth_secrets.yaml:/configs/auth_secrets.yaml
    environment:
      DB_PATH: *p
      LOG_PATH: *l
      LOG_ENC: json
      MODE: prod
      CLEAN_START: false
  signingservice:
    build:
      context: .
      dockerfile: ./signingService/Dockerfile
    image: verulink/signingservice:8a428f7
    pull_policy: build
    volumes:
      - ./signingService/config.yaml:/configs/config.yaml
      - ./signingService/secrets.yaml:/configs/keys.yaml # for loacal key pair setup
    ports:
      - 8080:8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"] 
      interval: 20s 
      timeout: 10s   
      retries: 3     
      start_period: 20s
    environment:
      AWS_SECRETS_MANAGER: true
volumes:
  db-path:
  log-path:
