---
- name: Update Attestor mTLS Certificates (GCP)
  hosts: all
  connection: ssh
  become: true
  vars:
    has_new_ca_cert: true
    has_new_attestor_cert: false

  vars_files:
    - devnet_vars.yaml

  
  pre_tasks:
    - name: Check if mTLS certificate update is enabled
      fail:
        msg: "mTLS certificate update is disabled. Set update_mtls_certificates to true to proceed."
      when: not update_mtls_certificates | default(false)

  tasks:
    - name: Check if gcloud CLI is installed
      ansible.builtin.command: gcloud --version
      register: gcloud_cli_check
      ignore_errors: true

    - name: Install gcloud CLI on Ubuntu Linux
      block:
        - name: Add Google Cloud SDK distribution URI as a package source
          ansible.builtin.shell: |
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          args:
            executable: /bin/bash

        - name: Import the Google Cloud public key
          ansible.builtin.shell: |
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          args:
            executable: /bin/bash

        - name: Update package list and install gcloud CLI
          ansible.builtin.apt:
            update_cache: yes
            name: google-cloud-cli
            state: present

        - name: Verify gcloud CLI installation
          ansible.builtin.command: gcloud --version
          register: gcloud_cli_verify

        - name: Display gcloud CLI version
          ansible.builtin.debug:
            msg: "gcloud CLI installed successfully: {{ gcloud_cli_verify.stdout }}"
      when: gcloud_cli_check is failed

    - name: Verify GCP access and permissions
      ansible.builtin.command: gcloud auth list --filter=status:ACTIVE --format="value(account)"
      register: gcp_auth_info

    - name: Display GCP auth info
      ansible.builtin.debug:
        msg: "GCP Access verified for account: {{ gcp_auth_info.stdout }}"

    - name: Check if secret exists in GCP Secret Manager
      ansible.builtin.command: gcloud secrets describe "{{ mtls_secret_name }}" --project="{{ gcp_project_id }}"
      register: secret_info
      ignore_errors: true

    - name: Fail if secret doesn't exist
      fail:
        msg: "Secret {{ mtls_secret_name }} does not exist in GCP Secret Manager"
      when: secret_info is failed

    - name: Download current secret value to /tmp/current_secret.json
      shell: |
        gcloud secrets versions access latest \
          --secret="{{ mtls_secret_name }}" \
          --project="{{ gcp_project_id }}" > /tmp/current_secret.json

    - name: Ensure .mtls directory exists
      ansible.builtin.file:
        path: "{{ install_dir }}/chainService/.mtls"
        state: directory
        mode: '0755'

    - name: Read config.yaml to get CA certificate file path
      ansible.builtin.slurp:
        src: "{{ install_dir }}/chainService/config.yaml"
      register: config_yaml_slurp
      when: has_new_ca_cert or has_new_attestor_cert

    - name: Parse config.yaml content into dictionary
      set_fact:
        config_yaml_dict: "{{ (config_yaml_slurp.content | b64decode | from_yaml) | default({}, true) }}"
      when: has_new_ca_cert or has_new_attestor_cert

    - name: Parse config.yaml to get CA certificate filename
      set_fact:
        ca_cert_filename: "{{ (config_yaml_dict.get('collector_service', {}).get('ca_certificate', '/configs/.mtls/ca.cer')) | basename }}"
      when: has_new_ca_cert
    
    - name: Print ca_cert_filename
      ansible.builtin.debug:
        msg: "ca_cert_filename: {{ ca_cert_filename }}"

    - name: Set CA certificate path
      set_fact:
        ca_cert_path: "{{ install_dir }}/chainService/.mtls/{{ ca_cert_filename }}"
      when: has_new_ca_cert

    - name: Parse config.yaml to get attestor certificate filename and set path
      set_fact:
        attestor_cert_filename: "{{ (config_yaml_dict.get('collector_service', {}).get('attestor_certificate', '/configs/.mtls/attestor1.crt')) | basename }}"
        attestor_cert_path: "{{ install_dir }}/chainService/.mtls/{{ attestor_cert_filename }}"
      when: has_new_attestor_cert

    - name: Get current CA certificate file stat
      ansible.builtin.stat:
        path: "{{ ca_cert_path }}"
      register: ca_cert_stat
      when: has_new_ca_cert

    - name: Download CA certificate from Base64 URL
      ansible.builtin.shell: |
        curl -sSL -o "{{ ca_cert_path }}" "$(echo '{{ new_ca_certificate_base64 }}' | base64 -d)"
      args:
        executable: /bin/bash

    - name: Set ownership of CA certificate file to match original
      ansible.builtin.file:
        path: "{{ ca_cert_path }}"
        owner: "{{ ca_cert_stat.stat.pw_name | default(omit) }}"
        group: "{{ ca_cert_stat.stat.gr_name | default(omit) }}"
        mode: "{{ ca_cert_stat.stat.mode | default(omit) }}"
      when: has_new_ca_cert and ca_cert_stat.stat.exists | default(false)

    - name: Read downloaded CA certificate
      ansible.builtin.slurp:
        src: "{{ ca_cert_path }}"
      register: ca_cert_slurp
      when: has_new_ca_cert

    - name: Read downloaded attestor certificate
      ansible.builtin.slurp:
        src: "{{ attestor_cert_path }}"
      register: attestor_cert_slurp
      when: has_new_attestor_cert
    
    - name: Update ca_certificate in secret JSON with new cert
      shell: |
        cert_content=$(cat "{{ ca_cert_path }}")
        jq --arg cert "$cert_content" '.ca_certificate = $cert' /tmp/current_secret.json > /tmp/updated_secret.json
      args:
        executable: /bin/bash

    - name: Update GCP Secret Manager with new certificates
      ansible.builtin.command: |
        gcloud secrets versions add "{{ mtls_secret_name }}" \
          --data-file="/tmp/updated_secret.json" \
          --project="{{ gcp_project_id }}"
      when: has_new_ca_cert or has_new_attestor_cert
      register: secret_update

    - name: Clean up all current temporary secret files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/updated_secret.json"
        - "/tmp/current_secret.json"
      when: has_new_ca_cert or has_new_attestor_cert

    - name: Display update summary
      ansible.builtin.debug:
        msg: |
          Certificate Update Summary:
          - CA Certificate: {{ 'Updated' if has_new_ca_cert else 'No change' }}
          - Attestor Certificate: {{ 'Updated' if has_new_attestor_cert else 'No change' }}

    - name: Restart docker compose services
      ansible.builtin.command: docker compose restart
      args:
        chdir: "{{ install_dir }}"
      when: has_new_ca_cert or has_new_attestor_cert
      register: docker_restart

    - name: Display restart status
      ansible.builtin.debug:
        msg: "Docker services restarted successfully"
      when: docker_restart is changed

    - name: Display no update message
      ansible.builtin.debug:
        msg: "No certificate updates required. All certificates are up to date."
      when: not has_new_ca_cert and not has_new_attestor_cert
