---
- name: Deploy Verulink Attestor Service
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    attestor_install_dir: "/home/{{ ansible_user }}/verulink_attestor"
    mtls_dir: "{{ attestor_install_dir }}/.mtls"
    github_base_url: "https://raw.githubusercontent.com/venture23-aleo/verulink/refs/heads"

  pre_tasks:
    - name: Include environment variables
      include_vars: "{{ env }}_vars.yml"

  tasks:
    - name: Create installation directory
      file:
        path: "{{ attestor_install_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Create mTLS directory
      file:
        path: "{{ mtls_dir }}"
        state: directory
        mode: '0750'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Determine branch based on environment
      set_fact:
        branch: "{{ 'develop' if env == 'devnet' else 'ci/ansible-deployment' if env == 'staging' else 'main' }}"


    - name: Download config template to local controller
      get_url:
        url: "{{ github_base_url }}/{{ branch }}/attestor/config.yaml.j2"
        dest: "./config.yaml.j2"
      delegate_to: localhost
      become: no

    - name: Render config locally and copy to remote
      template:
        src: "./config.yaml.j2"
        dest: "{{ attestor_install_dir }}/attestor_combined.yaml"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"


    - name: Read combined config
      slurp:
        src: "{{ attestor_install_dir }}/attestor_combined.yaml"
      register: combined_file

    - name: Split YAML documents
      set_fact:
        split_docs: "{{ (combined_file.content | b64decode).split('---') }}"

    - name: Write config sections
      copy:
        content: "{{ item.content | trim }}"
        dest: "{{ attestor_install_dir }}/{{ item.filename }}"
        mode: "{{ item.mode | default('0644') }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop:
        - { filename: "chain_config.yaml", content: "{{ split_docs[1] }}" }
        - { filename: "sign_config.yaml",  content: "{{ split_docs[2] }}" }
        - { filename: "secrets.yaml",      content: "{{ split_docs[3] }}", mode: "0600" }
        - { filename: ".env",              content: "{{ split_docs[4] }}" }

    - name: Write mTLS CA certificate from base64
      copy:
        content: "{{ ca_certificate | b64decode }}"
        dest: "{{ mtls_dir }}/ca.crt"
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Write mTLS attestor certificate from base64
      copy:
        content: "{{ attestor_certificate | b64decode }}"
        dest: "{{ mtls_dir }}/{{ attestor_name }}.crt"
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Write mTLS attestor key from base64
      copy:
        content: "{{ attestor_key | b64decode }}"
        dest: "{{ mtls_dir }}/{{ attestor_name }}.key"
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Install Docker on Ubuntu/Debian systems
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
        - name: Install required packages
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
            state: present
        - name: Create keyrings directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'
        - name: Add Docker's official GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: '0644'
        - name: Set correct permissions for Docker GPG key
          file:
            path: /etc/apt/keyrings/docker.asc
            mode: '0644'
        - name: Add Docker repository to apt sources
          apt_repository:
            repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker
        - name: Update apt cache after adding repository
          apt:
            update_cache: yes
        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
      when: ansible_os_family == "Debian"

    - name: Install Docker on RHEL/CentOS systems
      block:
        - name: Install dnf-plugins-core
          dnf:
            name: dnf-plugins-core
            state: present
        - name: Add Docker repository using shell
          shell: |
            sudo dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo
          args:
            creates: /etc/yum.repos.d/docker-ce.repo
        - name: Install Docker packages
          dnf:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
      when: ansible_os_family == "RedHat"

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Pull Docker images
      community.docker.docker_image:
        name: "{{ item }}"
        source: pull
      loop:
        - "{{ docker_image_tag_sign }}"
        - "{{ docker_image_tag_chain }}"

    - name: Start attestor services
      community.docker.docker_compose_v2:
        project_src: "{{ attestor_install_dir }}"
        state: present
        restarted: yes

    - name: Wait for services to be ready
      wait_for:
        port: "{{ item }}"
        timeout: 60
      loop:
        - 8080  # signing service port
        - 8081  # chain service port (adjust if different)

    - name: Verify services are running
      community.docker.docker_container_info:
        name: "{{ item }}"
      register: container_info
      loop:
        - "attestor-chainservice"
        - "attestor-signingservice"

    - name: Display service status
      debug:
        msg: "Service {{ item.name }} is {{ 'running' if item.State.Running else 'not running' }}"
      loop: "{{ container_info.results }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Check service logs
      shell: "docker logs {{ item }} --tail 20"
      register: service_logs
      loop:
        - "attestor-chainservice"
        - "attestor-signingservice"

    - name: Display recent logs
      debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ service_logs.results }}"
      when: item.stdout_lines is defined