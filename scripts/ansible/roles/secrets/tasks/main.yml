---
# Secrets role - Retrieve and sync secrets from cloud Secret Manager using CLI tools

- name: Set secret pull location
  set_fact:
    secret_pull_location: "{{ secret_pull | default('from_target') }}"

- name: Map environment to secret name prefix
  set_fact:
    env_prefix: >-
      {%- if env == 'mainnet' -%}
        mainnet
      {%- elif env == 'staging' -%}
        stg
      {%- elif env == 'devnet' -%}
        dev
      {%- else -%}
        {{ env | default('mainnet') }}
      {%- endif -%}

- name: Generate attestor secret name based on environment or per-host config
  set_fact:
    attestor_secret_name: >-
      {{
        attestor_secret_name |
        default(
          env_prefix + '/verulink/attestor/secrets'
          if infrastructure_provider == 'aws'
          else env_prefix + '_verulink_attestor_secrets'
        )
      }}

- name: Display secret name and pull location
  ansible.builtin.debug:
    msg: "Retrieving attestor secret: {{ attestor_secret_name }} (from {{ secret_pull_location }})"

- name: Ensure temporary directory exists
  file:
    path: /tmp/verulink_secrets
    state: directory
    mode: '0700'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Retrieve secret from GCP Secret Manager
  block:
    - name: Get latest secret version from GCP
      ansible.builtin.command: >
        gcloud secrets versions access latest
        --secret="{{ attestor_secret_name }}"
        --project="{{ gcp_project }}"
      register: gcp_secret_output
      no_log: true
      changed_when: false
      failed_when: false
      environment:
        CLOUDSDK_CORE_PROJECT: "{{ gcp_project }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ '/root/.gcp-sa.json' if (not gcp_using_instance_sa | default(false)) and gcp_sa_file.stat.exists | default(false) else '' }}"
      when: infrastructure_provider == "gcp"

    - name: Fail if GCP secret retrieval failed
      ansible.builtin.fail:
        msg: "Failed to retrieve secret from GCP: {{ gcp_secret_output.stderr | default('Unknown error') }}"
      when:
        - infrastructure_provider == "gcp"
        - gcp_secret_output.rc != 0

    - name: Save GCP secret to temporary file
      ansible.builtin.copy:
        content: "{{ gcp_secret_output.stdout }}"
        dest: /tmp/verulink_secrets/attestor_secret.json
        mode: '0600'
      no_log: true
      when: infrastructure_provider == "gcp"

- name: Retrieve secret from AWS Secrets Manager
  block:
    - name: Get secret value from AWS
      ansible.builtin.command: >
        aws secretsmanager get-secret-value
        --secret-id "{{ attestor_secret_name }}"
        --region "{{ region }}"
        --query SecretString
        --output text
      register: aws_secret_output
      no_log: true
      changed_when: false
      when: infrastructure_provider == "aws"

    - name: Save AWS secret to temporary file
      ansible.builtin.copy:
        content: "{{ aws_secret_output.stdout }}"
        dest: /tmp/verulink_secrets/attestor_secret.json
        mode: '0600'
      no_log: true
      when: infrastructure_provider == "aws"

- name: Parse secret JSON and extract values
  block:
    - name: Read secret JSON file
      ansible.builtin.slurp:
        src: /tmp/verulink_secrets/attestor_secret.json
      register: secret_json_content
      no_log: true

    - name: Parse secret JSON
      set_fact:
        secret_data: "{{ secret_json_content.content | b64decode | from_json }}"
      no_log: true

    - name: Extract mTLS certificates and keys
      set_fact:
        ca_certificate: "{{ secret_data.mtls.ca_certificate }}"
        attestor_certificate: "{{ secret_data.mtls.attestor_certificate }}"
        attestor_key: "{{ secret_data.mtls.attestor_key }}"
      no_log: true

    - name: Extract signing service credentials
      set_fact:
        bsc_private_key: "{{ secret_data.signing_service.bsc_private_key | default(secret_data.signing_service.ethereum_private_key) }}"
        bsc_wallet_address: "{{ secret_data.signing_service.bsc_wallet_address | default(secret_data.signing_service.ethereum_wallet_address) }}"
        ethereum_private_key: "{{ secret_data.signing_service.ethereum_private_key }}"
        ethereum_wallet_address: "{{ secret_data.signing_service.ethereum_wallet_address }}"
        aleo_private_key: "{{ secret_data.signing_service.aleo_private_key }}"
        aleo_wallet_address: "{{ secret_data.signing_service.aleo_wallet_address }}"
        signing_service_username: "{{ secret_data.signing_service.signing_service_username }}"
        signing_service_password: "{{ secret_data.signing_service.signing_service_password }}"
      no_log: true

    - name: Display secret retrieval success
      ansible.builtin.debug:
        msg: "Successfully retrieved and parsed secrets from {{ infrastructure_provider | upper }}"

- name: Clean up temporary secrets directory
  file:
    path: /tmp/verulink_secrets
    state: absent
