---
# Cloud CLI installation on target machine

- name: Set secret pull location
  set_fact:
    secret_pull_location: "{{ secret_pull | default('from_target') }}"

- name: Start cloud_common role - {{ infrastructure_provider | upper }} provider
  ansible.builtin.debug:
    msg: "Installing cloud CLI tools for {{ infrastructure_provider | upper }} on target machine"

# GCP CLI installation
- name: Check if GCP CLI is installed (on target)
  ansible.builtin.command: gcloud --version
  register: gcloud_cli_check
  ignore_errors: true
  no_log: true
  when:
    - infrastructure_provider == "gcp"
    - secret_pull_location == "from_target"

- name: Display GCP CLI check result
  ansible.builtin.debug:
    msg: "GCP CLI {{ 'is already installed' if gcloud_cli_check.rc == 0 else 'not found' }} on target machine"
  when: infrastructure_provider == "gcp"

- name: Install GCP CLI on Ubuntu if missing (target only)
  block:
    - name: Update apt package index
      ansible.builtin.apt:
        update_cache: yes

    - name: Install dependencies for GCP CLI
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
          - curl
        state: present

    - name: Add Google Cloud SDK apt key
      ansible.builtin.shell: |
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
      args:
        executable: /bin/bash

    - name: Add Google Cloud SDK apt repository
      ansible.builtin.shell: |
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      args:
        executable: /bin/bash

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install Google Cloud CLI
      ansible.builtin.apt:
        name: google-cloud-cli
        state: present

    - name: Verify GCP CLI
      ansible.builtin.command: gcloud --version
      register: gcloud_cli_verify

    - name: Display GCP CLI version
      ansible.builtin.debug:
        msg: "GCP CLI installed: {{ gcloud_cli_verify.stdout }}"
  when:
    - infrastructure_provider == "gcp"
    - secret_pull_location == "from_target"
    - gcloud_cli_check.rc != 0

# AWS CLI installation
- name: Check if AWS CLI is installed (on target)
  ansible.builtin.shell: which aws && aws --version
  register: aws_cli_check
  failed_when: false
  changed_when: false
  when:
    - infrastructure_provider == "aws"
    - secret_pull_location == "from_target"

- name: Display AWS CLI check result
  ansible.builtin.debug:
    msg: "AWS CLI {{ 'is already installed' if aws_cli_check.rc == 0 else 'not found' }} on target machine"
  when: infrastructure_provider == "aws"

- name: Install AWS CLI v2 if missing (target only)
  block:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install unzip
      ansible.builtin.apt:
        name: unzip
        state: present

    - name: Download AWS CLI bundle
      ansible.builtin.get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: "/tmp/awscliv2.zip"

    - name: Unzip AWS CLI
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: true

    - name: Install AWS CLI
      ansible.builtin.command: sudo ./aws/install
      args:
        chdir: /tmp
      become: true

    - name: Verify AWS CLI
      ansible.builtin.command: aws --version
      register: aws_cli_verify

    - name: Display AWS CLI version
      ansible.builtin.debug:
        msg: "AWS CLI installed: {{ aws_cli_verify.stdout }}"

    - name: Cleanup AWS CLI temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/awscliv2.zip
        - /tmp/aws
  when:
    - infrastructure_provider == "aws"
    - secret_pull_location == "from_target"
    - aws_cli_check.rc != 0
