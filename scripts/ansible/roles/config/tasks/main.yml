---
- name: Create mTLS directory
  file:
    path: "{{ mtls_dir }}"
    state: directory
    mode: '0750'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Display environment
  debug:
    msg: "Environment: {{ env }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Determine branch based on environment
  set_fact:
    branch: "{{ branch | default('develop' if env == 'devnet' else 'staging' if env == 'staging' else 'main') }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Display branch
  debug:
    msg: "Branch: {{ branch }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Download config template locally
  get_url:
    url: "{{ github_base_url }}/{{ branch }}/attestor/config.yaml.j2"
    dest: "./config.yaml.j2"
  delegate_to: localhost
  become: no
  when: operation | default('deploy') not in ['patch', 'update']

- name: Render config locally and copy to remote
  template:
    src: "./config.yaml.j2"
    dest: "{{ attestor_install_dir }}/attestor_combined.yaml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Read combined config file
  slurp:
    src: "{{ attestor_install_dir }}/attestor_combined.yaml"
  register: combined_file
  when: operation | default('deploy') not in ['patch', 'update']

- name: Split YAML documents
  set_fact:
    split_docs: "{{ (combined_file.content | b64decode).split('---') }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Write individual config sections
  copy:
    content: "{{ item.content | trim }}"
    dest: "{{ attestor_install_dir }}/{{ item.filename }}"
    mode: "{{ item.mode | default('0644') }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - { filename: "chain_config.yaml", content: "{{ split_docs[1] }}" }
    - { filename: "sign_config.yaml",  content: "{{ split_docs[2] }}" }
    - { filename: "secrets.yaml",      content: "{{ split_docs[3] }}", mode: "0600" }
    - { filename: ".env",              content: "{{ split_docs[4] }}" }
  no_log: true
  when: operation | default('deploy') not in ['patch', 'update']

- name: Write mTLS CA certificate
  copy:
    content: "{{ ca_certificate }}"
    dest: "{{ mtls_dir }}/ca.crt"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Write mTLS attestor certificate
  copy:
    content: "{{ attestor_certificate }}"
    dest: "{{ mtls_dir }}/{{ attestor_name }}.crt"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Write mTLS attestor key
  copy:
    content: "{{ attestor_key }}"
    dest: "{{ mtls_dir }}/{{ attestor_name }}.key"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: operation | default('deploy') not in ['patch', 'update']

- name: Include update tasks
  include_tasks: update.yml
  when: operation | default('deploy') == 'update'

- name: Include patch tasks
  include_tasks: patch.yml
  when: operation | default('deploy') == 'patch'
