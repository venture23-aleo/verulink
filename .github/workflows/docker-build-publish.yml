name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - staging
      - develop
      - ci/add-docker-image-build-workflow
    tags:
      - 'v*'

permissions:
  id-token: write 
  contents: read

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set image tags and other variables
        run: |
          echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "IS_TAG=true" >> $GITHUB_ENV
            echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "IS_TAG=false" >> $GITHUB_ENV
          fi

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.9.2

      - name: Build signingService
        working-directory: attestor
        run: |
          docker build \
            -f ./signingService/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-sign:${SHORT_SHA} \
            $( [ "$IS_TAG" = "true" ] && echo "-t ${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-sign:${TAG_NAME}" ) \
            .

      - name: Push and sign verulink-attestor-sign image
        env:
          COSIGN_YES: "true"
          IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-sign:${SHORT_SHA}
        run: |
          set -e

          echo "Pushing image: $IMAGE"
          docker push $IMAGE

          # Retrieve the digest using docker CLI
          DIGEST=$(docker image inspect $IMAGE --format '{{index .RepoDigests 0}}' | awk -F@ '{print $2}')

          if [ -z "$DIGEST" ]; then
            echo "❌ Digest not found. Image may not have been pushed correctly."
            exit 1
          fi

          echo "Digest: $DIGEST"

          # Sign the image using the digest
          cosign sign "${IMAGE%@*}@${DIGEST}"



      - name: Build chainService
        working-directory: attestor
        run: |
          docker build \
            -f ./chainService/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-chain:${SHORT_SHA} \
            $( [ "$IS_TAG" = "true" ] && echo "-t ${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-chain:${TAG_NAME}" ) \
            ./chainService

      - name: Push and sign verulink-attestor-chain image
        env:
          COSIGN_YES: "true"
          IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/verulink-attestor-chain:${SHORT_SHA}
        run: |
          set -e
      
          echo "Pushing image: $IMAGE"
          docker push $IMAGE
      
          # Retrieve the digest using docker CLI
          DIGEST=$(docker image inspect $IMAGE --format '{{index .RepoDigests 0}}' | awk -F@ '{print $2}')
      
          if [ -z "$DIGEST" ]; then
            echo "❌ Digest not found. Image may not have been pushed correctly."
            exit 1
          fi
      
          echo "Digest: $DIGEST"
      
          # Sign the image using the digest
          cosign sign "${IMAGE%@*}@${DIGEST}"